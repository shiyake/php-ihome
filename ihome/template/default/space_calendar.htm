<!--{eval $_TPL['titles'] = array('日历');}-->
<!--{template header}-->

<!--{if !empty($_SGLOBAL[inajax])}-->
	<div id="space_blog" class="feed">
		<h3 class="feed_header">
			<a href="cp.php?ac=arrangement" class="r_option" target="_blank" style="font-size:14px;">发布新安排</a>
			校园日历(共 $count 篇)
		</h3>
		<!--{if $count}-->
		<ul class="line_list">
		<!--{loop $list $value}-->
			<li>
				<span class="gray r_option"><!--{date('m-d H:i',$value[starttime],0)}--></span>
				<h4><a href="space.php?uid=$space[uid]&do=arrangement&id=$value[arrangementid]" target="_blank" >$value[subject]</a></h4>
            
                <div class="detail">
					$value[message]
				</div>
			</li>
		<!--{/loop}-->
		</ul>
		<div class="page">$multi</div>
		<!--{else}-->
		<div style="text-align:center;margin-top:75px;"><img src="image/icons/no_status.png"/><p style="color:#777;">还没有相关的校园日历。</p></div>
		<!--{/if}-->
	</div>
<!--{else}-->

<script language="javascript" type="text/javascript" src="source/script_calendar.js"></script>
<script type="text/javascript" src="plugin/fullcalendar/lib/jquery.min.js"></script>
        <script type="text/javascript">
            var j11 = jQuery.noConflict();
        </script>
<script type="text/javascript" src="plugin/fullcalendar/lib/moment.min.js"></script>
<script type="text/javascript" src="plugin/fullcalendar/fullcalendar.min.js"></script>
<script type="text/javascript" src="plugin/fullcalendar/zh-cn.js"></script>
<link rel="stylesheet" href="plugin/fullcalendar/fullcalendar.min.css">

<h4 class="title title30">日历
    <div class="r_option">
        <a style="font-size:14px;line-height:30px;" href="cp.php?ac=arrangement">发布新安排</a>
    </div>    
</h4>
<style>
    .h_status a {
        color: #777;
        margin-right: 5px;
    }

    .h_status .active {
        color: #01B6F9;
    }
    .avatar48 {
        height: 64px;
        width: 64px;
        border-radius: 50%;
        border: 2px solid #fff;
        box-shadow: 3px 5px 4px -2px rgb(220, 220, 220);
    }
    .avatar48 img {
        height: 60px;
        width: 60px;
    }
    .eventColor{
        position: relative;
        border: 1px solid #000;
        cursor: pointer;
        height: 14px;
        margin: 0 2.5px;
        width: 14px;
        vertical-align: top;
        display: inline-block;
    }
    .eventColorActive{
        background: url(/image/combined_v46_vr.png);
        background-position: -95px -50px;
        height: 10px;
        width: 10px;
        left: -1px;
        top: -1px;
        margin: 3px;
        overflow: hidden;
        position: relative;
        vertical-align: top;
    }
</style>

<div id="content" style="padding-left:10px;margin-top: 10px;border-right:none;background: #ffffff;">

</div>

	<div class="sidebox" style="position:absolute;right:0;border-bottom:none;margin-top:20px;">
		<div class="calendarbox" id="calendar_info"></div>
        </div>
        
	<script type="text/javascript" charset="$_SC[charset]">
		function showcalendar_new(month){
			var month = month ? "&month="+month : "";
			ajaxget('cp.php?ac=calendar&op=calendar' + month + '&date=$_GET[date]&url=<!--{eval echo urlencode($calendarurl)}-->&calendar_id=$id', 'calendar_info');
		}
		showcalendar_new();
	</script>
    
    <div class="sidebox" style="position:absolute;right:0; top:280px;border-bottom:none;margin-top:20px;">
        <h4 class="title">
            <p class="r_option" ><a href="cp.php?ac=calendar&op=add" id="calendar_add" onclick="ajaxmenu(event, this.id)">添加</a></p>
            我的日历
        </h4>
        
        <ul class="post_list line_list" id="my_calendar_list" style="width:190px; min-width:172px;">
        <!--{loop $list $value}-->
        <li id="calendar_list_$value[id]_li">
        <a class="c_edit" onclick="ajaxmenu(event, this.id)" id="c_edit_$value[id]" href="cp.php?ac=calendar&op=edit&calendar_id=$value[id]">编辑</a>
        <a class="c_delete" onclick="ajaxmenu(event, this.id)" id="c_delete_$value[id]" href="cp.php?ac=calendar&op=delete&calendar_id=$value[id]">删除</a>
        <a href="space.php?uid=$space[uid]&do=calendar&id=$value[id]">$value[calendar_name]</a>
        </li>
		<!--{/loop}-->
	</ul>

    </div>
<!--{/if}-->

    <script type="text/javascript">
        var clickDate = '';
        var clickDayEvent = null;
        j11(function () {
            var showFcMoment = j11.fullCalendar.moment("$showFcDate", 'YYYY-M-D');
            initFc('content', showFcMoment);
            bindMenuEvent();
        });

        var fc = null;
        var lastClickEventJSEvent = null;
        function initFc(id, middleDate){
            fc = j11('#' + id);
            middleDate ? null : middleDate = j11.fullCalendar.moment();
            var fShowFirstDay = parseInt(j11.fullCalendar.moment(middleDate).subtract(2, 'days').format('e'));
            var fHiddenDays = [parseInt(j11.fullCalendar.moment(middleDate).subtract(2, 'days').format('e')),
                parseInt(j11.fullCalendar.moment(middleDate).add(4, 'days').format('e'))];

            var eventUrl = '/cp.php?ac=calendar&op=getCalendarInfo';
            var calendarId = location.search.match(/&id=(\d+)/);
            if(calendarId){
                calendarId = calendarId[1];
                eventUrl += '&calendar_id=' + calendarId;
            }else{
                calendarId = 0;
            }
            fc.fullCalendar({
                defaultDate : middleDate,
                height: 1100,
                contentHeight: 770,
                header: false,
                lang: 'zh-cn',
                defaultView: 'agendaWeek',
                allDaySlot: false,
                axisFormat : 'H:00',
                minTime : '07:00:00',
                maxTime : '22:00:00',
                columnFormat : 'M-D ddd',
//                weekends : false,
                editable : true,
                firstDay : fShowFirstDay,
                hiddenDays : fHiddenDays,
                eventDurationEditable : false,
                events : eventUrl,
                eventClick : function(calEvent, jsEvent, view){
                    removeNoneMenu();
                    var eaId = 'eventID' + calEvent.id;
                    j11(jsEvent.target).attr('id', eaId);
                    j11(jsEvent.target).attr('href', '/cp.php?ac=calendar&op=showEvent&calendar_id=' + calendarId + '&calendar_info_id=' + calEvent.id);
                    ajaxmenu(jsEvent, eaId, 0, 0, 'beforeShowAddEventHtmlA');
                    lastClickEventJSEvent = jsEvent;
                },
                dayClick: function(date, jsEvent, view) {
                    removeNoneMenu();
                    clickDate = date;
                    clickDayEvent = jsEvent;
                    var eaId = 'addEvent' + date.format('HHMDHm');
                    var htmlA = j11('<a>', {'id' : eaId, 'href' : '/cp.php?ac=calendar&op=addEvent&calendar_id=' + calendarId,
                        'style' : 'position: fixed;left: ' + jsEvent.pageX + 'px;top: ' + jsEvent.pageY + 'px;'});
                    j11(jsEvent.target).append(htmlA);
                    ajaxmenu(jsEvent, eaId, 0, 0, 'beforeShowAddEventHtmlA');
                }
            });
        }

        function removeNoneMenu(){
            j11('#append_parent>.popupmenu_popup').remove();
        }

        function beforeShowAddEventHtmlA(eaId){
            //j11('#content #' + eaId).remove();//移除添加的定位标签a
            if(!j11('#start_d')){
                setTimeout(beforeShowAddEventHtmlA, 500);
                return false;
            }

            var showDate = clickDate.format('YYYY-M-D');
            j11('#start_d').val(showDate);
            j11('#end_d').val(showDate);
            showDateTime(j11('#start_t'), showDate);
            showDateTime(j11('#end_t'), showDate);
        }

        function bindMenuEvent(){
            j11('#append_parent').delegate('.eventColor', 'mouseover', function(){
                j11(this).css('border-color', '#000');
            });
            j11('#append_parent').delegate('.eventColor', 'mouseout', function(){
                j11(this).css('border-color', j11(this).css('background-color'));
            });
            j11('#append_parent').delegate('.eventColor', 'click', function(){
                j11('.eventColorActive').remove();
                j11('.eventColorActiveInput').remove();
                j11(this).append(j11('<div>', {'class' : 'eventColorActive'}));
                j11(this).append(j11('<input>', {'type' : 'hidden', 'value' : j11(this).css('background-color'), 'name' : 'bgcolor', 'class' : 'eventColorActiveInput'}));
            });

            j11('#calendar').delegate(' td', 'click', function(){
                var sDate = j11('#start_d').val();
                var eDate = j11('#end_d').val();
                showDateTime(j11('#start_t'), sDate);
                showDateTime(j11('#end_t'), eDate);

                var sUnix = new Number(j11.fullCalendar.moment(sDate, 'YYYY-MM-DD').format('X'));
                var eUnix = new Number(j11.fullCalendar.moment(eDate, 'YYYY-MM-DD').format('X'));
                if (sUnix > eUnix) {
                    j11('#end_d').parent().addClass('has-error');
                } else {
                    j11('#end_d').parent().removeClass('has-error');
                }
            });
        }

        function showDateTime(obj, date){
            if(!date) date = clickDate.format('YYYY-M-D');
            obj.html('');
            var st = parseInt(j11.fullCalendar.moment(date + ' 7:00', 'YYYY-M-D H:mm').format('X')) * 1000;
            var et = parseInt(j11.fullCalendar.moment(date + ' 21:00', 'YYYY-M-D H:mm').format('X')) * 1000;
            var i = st;
            do{
                var html = j11.fullCalendar.moment(i).format('aHH:mm');
                obj.append(j11('<option>', {'html' : html, 'value' : i}));
                i += 60 * 30 * 1000;
            }while(i <= et);
        }

        function addEventOK(){
            location.reload();
        }

        function editEventOK(res, a){
            location.reload();
        }
        function deleteEvent(calendar_id, eventID){
            var url = '/cp.php?ac=calendar&op=deleteEvent';
            j11.getJSON(url, {'calendar_id' : calendar_id, 'calendar_info_id' : eventID}, function(res){
                location.reload();
            });
        }

    </script>

<!--{template footer}-->
